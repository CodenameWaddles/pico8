pico-8 cartridge // http://www.pico-8.com
version 30
__lua__
_pal={
0,129,1,3,
134,5,6,7,
8,9,10,11,
12,140,14,15}

px=4.5
py=10.5
pa=0

x=0
y=0
vx=0
vy=0
ox=0
oy=0
dx=0
dy=0
ix=0
iy=0
h=40
cs={13,4,12}
fac=1

function _init()
	for i=0,15 do
		pal(i,_pal[i+1],1)
	end
end

function _draw()
	
	// player control
	if btn(0) then
		pa+=0.01
		if pa>1 then
			pa-=1
		end
	end
	if btn(1) then
		pa-=0.01
		if pa<0 then
			pa+=1
		end
	end
	if btn(2) then
		px+=cos(pa)*0.1
		py+=sin(pa)*0.1
	end
	if btn(3) then
		px-=cos(pa)*0.1
		py-=sin(pa)*0.1
	end
	
	// background
	cls(5)
	rectfill(0,64,128,128,6)
	
	for i=0,127 do
		x=px
		y=py
		
		// find ray direction
		---[[ for panoramic view
		vx=cos(pa-(i-64)/512)
		vy=sin(pa-(i-64)/512)
		--]]
		--[[ for straight lines
		vx=cos(pa+atan2(1,(i-64)/64))
		vy=sin(pa+atan2(1,(i-64)/64))
		fac=cos(atan2(1,(i-64)/64))
		--]]
		
		
		dx=abs(1/vx)
		dy=abs(1/vy)
		ix=vx>0 and 1 or -1
		iy=vy>0 and 1 or -1
		if vx>0 then
			ox=(flr(x)-x+1)/vx
		else
			ox=abs((x-flr(x))/vx)
		end
		if vy>0 then
			oy=(flr(y)-y+1)/vy
		else
			oy=abs((y-flr(y))/vy)
		end
		
		while true do
			// horizontal intersection
			if ox<oy then
				// iterate raycast
				x+=ix
				d=ox
				ox+=dx
				// check for collsion
				if mget(x,y)>0 or x<0 or x>31 or y<0 or y>31 then
					// line endpoints (rounded)
					tw=flr(64-h/d/fac)
					bw=flr(64+h/d/fac)
					tline(i,tw,i,bw,(py+vy*d)%1*2+(mget(x,y)-1)*2,0,0,2/(bw-tw))
					break
				end
			else // vertical intersection
				y+=iy
				d=oy
				oy+=dy
				if mget(x,y)>0 or x<0 or x>31 or y<0 or y>31 then
					tw=flr(64-h/d/fac)
					bw=flr(64+h/d/fac)
					tline(i,tw,i,bw,(px+vx*d)%1*2+(mget(x,y)-1)*2,0,0,2/(bw-tw))
					break
				end
			end
		end
	end
end
__gfx__
00000000dddddddd44444444cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000dddddddd44444444cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000dddddddd44444444cccccccc000000000000000000000000000000000000007777700000000000000000000000000000000000000000000000000000
00000000dddddddd44444444cccccccc000000000000000000000000000000000000770060077000000000000000000000000000000000000000000000000000
00000000dddddddd44444444cccccccc000000000000000000000000000000000007005060500700000000000000000000000000000000000000000000000000
00000000dddddddd44444444cccccccc000000000000000000000000000000000070605060506070000000000000000000000000000000000000000000000000
00000000dddddddd44444444cccccccc000000000000000000000000000000000070060565060070000000000000000000000000000000000000000000000000
00000000dddddddd44444444cccccccc000000000000000000000000000000000700006565600007000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000700000666000007000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000700000080000007000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000700000000000007000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000700000000000007000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000070000000000070000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000070000000000070000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000007000000000700000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000770000077000000000000000000000000000000000000000000000000000
ddddd1dddddd1dd15664444465444466ccccccc7c7cccccc00000000000000000000007777700000000000000000000000000000000000000000000000000000
ddddd11111111dd15644555445554446cddddddddddddddc00000000000000000000000000000000000000000000000000000000000000000000000000000000
2ddd21dddd1d1dd15555555555465444c7ccc7c7ccccccdc00000000000000000000000000000000000000000000000000000000000000000000000000000000
222221dddd1d1dd15566656665445555c7cc7c7cccccccdc00000000000000000000000000000000000000000000000000000000000000000000000000000000
1111112dd21d12216444656446555554c7c7c7ccccccccd700000000000000000000000000000000000000000000000000000000000000000000000000000000
dd1dd122221211114444454444446654c77c7cccccccccdc00000000000000000000000000007777777777777777777000000000000000000000000000000000
dd1dd111111111d1444455554444465477c7ccccccccccd700000000000000000000000000000006005006005006000000000000000000000000000000000000
dd1221ddddd1d1d15555555554455555c77cac44ccccc7dc00000000000000000000000000000000605006005060000000000000000000000000000000000000
dd11112ddd21d1d1556466655555556677ccaca4cccc7cdc00000000000000000000000000000000060506050600000000000000000000000000000000000000
dd1dd1222221d1214544446556446644c7ccac44ccc7c7dc00000000000000000000000000000000006506056000000000000000000000000000000000000000
221dd1111111d1114544444564444444c7cccccccc7c7cdc00000000000000000000000000000000000656560000000000000000000000000000000000000000
111221ddddd121215555445544444455c7ccccccc7c7ccdc00000000000000000000000000000000000066600000000000000000000000000000000000000000
dd1111ddddd111114655555555555555c7cccccc7c7cccdc00000000000000000000000000000000000008000000000000000000000000000000000000000000
dd1dd1ddddd1ddd14466566446655444c7ccccc7c7ccccdc00000000000000000000000000000000000000000000000000000000000000000000000000000000
dd1dd12ddd21ddd14446564444465444c7777777777777dc00000000000000000000000000000000000000000000000000000000000000000000000000000000
22122122222122215555555555555555ccccc7c7cccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2021222324250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3031323334350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010102020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000100000200000200000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000100000000000200000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000300000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000100000000000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010100000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020302020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000100000100000100000100000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000100000100000100000100000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
